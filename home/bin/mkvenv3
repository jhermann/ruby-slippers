#! /bin/bash
#
# Make a Python3 virtualenv.
#
set -e
#set -x

base_python="$(which python3.9 python3.11 python3.8 python3.6 python3 | head -n1)"
venv_basedir="$HOME/.local/py3venv"  # venv default base directory
venv_name="${1:?You MUST provide a virtualenv name}"
venv_dir="$venv_basedir/$venv_name"
venv_prompt="$venv_name"

if [ "$venv_name" = '.' ]; then
   venv_name=".venv"
   venv_dir="$(pwd)/$venv_name"
   venv_prompt=$(basename "$(pwd)")
fi

echo "Creating $venv_dir…"
deactivate 2>/dev/null || :
"$base_python" -m venv --prompt "$venv_prompt" "$venv_dir"

# Update / install basic tools
echo "Updating tools…"
echo pip setuptools wheel bpython pip-upgrader yolk3k \
    | xargs -n1 "$venv_dir/bin/python" -m pip -q install -U

# Report activation instructions
if test "$(which python 2>/dev/null)" != "$venvdir/bin/python" ; then
    echo
    echo "~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~"
    echo "Please call the following command to activate this virtualenv..."
    echo "." $(command cd >/dev/null "$venv_dir/bin" && pwd)"/activate"
    echo "~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~"
fi
