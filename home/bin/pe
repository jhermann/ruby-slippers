#! /bin/bash
#
# "gedit" wrapper
#

# Clean environment for built-in interpreter
deactivate 2>/dev/null || :
export PYTHONPATH=

# Put system binaries upfront
export PATH=/usr/bin:$PATH

# Look out for grep results (containing a ':') and load file at the matching line
args=()
files=()
for arg in "$@"; do
    case "$arg" in
        -*)
            args+=("$arg")
            ;;
        ?*~*)
            match=$(grep -nim1 -E -e "${arg#*~}" "${arg%%~*}")
            test -n "$match" && files+=("${arg%%~*}:${match%%:*}") || files+=("${arg%%~*}")
            ;;
        *)
            files+=("$arg")
            ;;
    esac
done

# Open files
for filename in "${files[@]}"; do
    line=""
    test "${filename%%:*}" = "$filename" || line=+$(cut -f2 -d: <<<"$filename")
    filename="${filename%%:*}"
    if [[ "$filename" == [ab]/* ]]; then
        # treat "git diff" pasted filenames special
        test -d "${filename:0:1}" || filename="${filename:2}"
    fi

    case $(lsb_release -cs) in
        trusty)
            gedit "${args[@]}" "$filename" $line >>/tmp/gedit-$USER.log 2>&1 &
            disown
            ;;
        precise | lucid | *)
            gedit --background "${args[@]}" "$filename" $line
            ;;
    esac
done

# Bring window to front
if which wmctrl >/dev/null; then
    test "$(dirname $filename)" != '.' || filename="$(pwd)/$filename"
    title_re="^[^ ]+ +[^ ]+ +[^ ]+ +$(basename $filename).*/$(basename $(dirname $filename)). - gedit\$"
    for i in seq 10; do
        wid=$(wmctrl -l | egrep "$title_re" | tail -n1 | cut -f1 -d' ')
        test -n "$wid" && wmctrl -i -a "$wid" && break || sleep .1
    done
fi
